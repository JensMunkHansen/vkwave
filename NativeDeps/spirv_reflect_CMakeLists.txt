cmake_minimum_required(VERSION 3.21)
project(spirv-reflect VERSION 1.0.0 LANGUAGES C)

add_library(spirv-reflect-static STATIC
  spirv_reflect.c
)

target_include_directories(spirv-reflect-static
  PUBLIC
    $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}>
    $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
    $<INSTALL_INTERFACE:include>
)

# Install library
include(GNUInstallDirs)
install(TARGETS spirv-reflect-static EXPORT spirv-reflect-staticTargets
  ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR}
  LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
)

# Install headers
install(FILES spirv_reflect.h
  DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}
)

# Install SPIR-V unified1 headers (needed by spirv_reflect.h)
# spirv_reflect.h uses #include "./include/spirv/unified1/spirv.h" (relative path),
# so install under include/include/ to match the relative resolution from the header.
install(DIRECTORY include/
  DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}/include
  FILES_MATCHING PATTERN "*.h"
)

# Export targets
install(EXPORT spirv-reflect-staticTargets
  FILE spirv-reflect-staticTargets.cmake
  NAMESPACE spirv-reflect::
  DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/spirv-reflect-static
)

# Generate config files for find_package(spirv-reflect-static CONFIG)
include(CMakePackageConfigHelpers)
write_basic_package_version_file(
  "${CMAKE_CURRENT_BINARY_DIR}/spirv-reflect-staticConfigVersion.cmake"
  VERSION ${PROJECT_VERSION}
  COMPATIBILITY SameMajorVersion
)

file(WRITE "${CMAKE_CURRENT_BINARY_DIR}/spirv-reflect-staticConfig.cmake"
[=[
include("${CMAKE_CURRENT_LIST_DIR}/spirv-reflect-staticTargets.cmake")
]=])

install(FILES
  "${CMAKE_CURRENT_BINARY_DIR}/spirv-reflect-staticConfig.cmake"
  "${CMAKE_CURRENT_BINARY_DIR}/spirv-reflect-staticConfigVersion.cmake"
  DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/spirv-reflect-static
)
